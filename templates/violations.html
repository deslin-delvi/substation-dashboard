{% extends "base.html" %}

{% block title %}Violations History - Substation PPE Safety{% endblock %}

{% block content %}
<div class="row justify-content-between align-items-center mb-4">
    <div class="col">
        <h2 class="mb-0">
            <i class="bi bi-exclamation-triangle text-danger me-2"></i>
            Safety Violations ({{ violations.total }})
        </h2>
    </div>
    <div class="col-auto">
        <span class="badge bg-info me-2">{{ violations.per_page }} per page</span>
        <span class="badge bg-secondary">Page {{ violations.page }}/{{ violations.pages }}</span>
    </div>
</div>

<!-- Violations Grid -->
<div class="row g-4 mb-5">
    {% for violation in violations.items %}
    <div class="col-xl-3 col-lg-4 col-md-6">
        <div class="card h-100 shadow-sm border-0 hover-shadow">
            <!-- Violation Type Badge -->
            <div class="position-absolute top-0 start-0 m-2" style="z-index: 10;">
                {% if violation.violation_type == 'manual_override' %}
                <span class="badge bg-warning text-dark">
                    <i class="bi bi-hand-index"></i> MANUAL OVERRIDE
                </span>
                {% elif violation.violation_type == 'auto_mode_restored' %}
                <span class="badge bg-info">
                    <i class="bi bi-arrow-clockwise"></i> AUTO RESTORED
                </span>
                {% elif violation.violation_type == 'ppe_incomplete' %}
                <span class="badge bg-danger">
                    <i class="bi bi-shield-x"></i> PPE VIOLATION
                </span>
                {% endif %}
            </div>
            
            {% if violation.image_path %}
            <!-- Use image_path directly (it's now just the filename) -->
            <img src="{{ url_for('serve_violation_image', filename=violation.image_path) }}" 
                     class="card-img-top" style="height: 200px; object-fit: cover;"
                     alt="Violation at {{ violation.timestamp.strftime('%H:%M:%S') }}">
                <div class="position-absolute top-0 end-0 m-2">
                    <span class="badge bg-danger">PPE FAIL</span>
                </div>

            {% else %}
            <div class="bg-secondary text-white d-flex align-items-center justify-content-center" style="height: 200px;">
                <i class="bi bi-camera-video-off display-4 opacity-50"></i>
            </div>
            {% endif %}
            
            <div class="card-body d-flex flex-column p-3">
                <h6 class="card-title mb-2">
                    <i class="bi bi-clock me-1"></i>
                    <strong>{{ violation.timestamp.strftime('%Y-%m-%d') }}</strong>
                    {{ violation.timestamp.strftime('%H:%M:%S') }}
                </h6>
                
                {% if violation.missing_items and violation.missing_items != 'N/A' %}
                <div class="mb-2">
                    <i class="bi bi-x-circle text-danger me-1"></i>
                    <span class="text-danger fw-medium">{{ violation.missing_items }}</span>
                </div>
                {% endif %}
                
                <div class="mb-3">
                    {% if violation.gate_action == 'DENIED' %}
                    <span class="badge bg-danger fs-6">
                        <i class="bi bi-lock"></i> {{ violation.gate_action }}
                    </span>
                    {% elif violation.gate_action == 'MANUAL_OPEN' %}
                    <span class="badge bg-success fs-6">
                        <i class="bi bi-unlock"></i> GATE OPENED
                    </span>
                    {% elif violation.gate_action == 'MANUAL_CLOSE' %}
                    <span class="badge bg-warning text-dark fs-6">
                        <i class="bi bi-lock"></i> GATE CLOSED
                    </span>
                    {% elif violation.gate_action == 'AUTO_MODE' %}
                    <span class="badge bg-info fs-6">
                        <i class="bi bi-gear"></i> AUTO MODE
                    </span>
                    {% else %}
                    <span class="badge bg-secondary fs-6">
                        {{ violation.gate_action }}
                    </span>
                    {% endif %}
                </div>
                
                {% if violation.operator_id %}
                <small class="text-muted mb-2">
                    <i class="bi bi-person-check"></i> Operator ID: {{ violation.operator_id }}
                </small>
                {% endif %}
                
                <!-- üîß FIX: Show auto-generated notes as read-only text, not in textarea -->
                {% if violation.notes and (violation.violation_type == 'manual_override' or violation.violation_type == 'auto_mode_restored') %}
                <div class="alert alert-light py-2 px-2 mb-2" style="font-size: 0.85rem;">
                    <i class="bi bi-info-circle"></i> {{ violation.notes }}
                </div>
                {% endif %}
                
                
                <!-- Supervisor Notes with Save Button -->
                <div class="mt-auto">
                    <label class="form-label small text-muted mb-1">
                        <i class="bi bi-pencil-square"></i> Supervisor Notes:
                    </label>
                    <textarea class="form-control form-control-sm mb-2" 
                              id="notes-{{ violation.id }}"
                              rows="2" 
                              placeholder="Add your notes here..."
                              style="resize: vertical;">{{ violation.supervisor_notes or '' }}</textarea>
                    
                    <!-- Save Button -->
                    <button class="btn btn-sm btn-primary w-100" 
                            onclick="saveNote({{ violation.id }})"
                            id="save-btn-{{ violation.id }}">
                        <i class="bi bi-save"></i> Save Note
                    </button>
                    
                    <!-- Status Message -->
                    <div id="status-{{ violation.id }}" 
                         class="small mt-1 text-center" 
                         style="min-height: 20px; opacity: 0; transition: opacity 0.3s;">
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="text-center py-5">
            <i class="bi bi-check-circle display-1 text-success mb-4"></i>
            <h3 class="text-success mb-3">üéâ Perfect Safety Record!</h3>
            <p class="lead text-muted">No PPE violations detected yet.</p>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination -->
{% if violations.pages > 1 %}
<nav aria-label="Violations pagination">
    <ul class="pagination justify-content-center">
        {% if violations.has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ violations.prev_num }}">
                <i class="bi bi-chevron-left"></i> Previous
            </a>
        </li>
        {% endif %}
        <li class="page-item active">
            <span class="page-link">{{ violations.page }} / {{ violations.pages }}</span>
        </li>
        {% if violations.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ violations.next_num }}">
                Next <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<style>
.hover-shadow {
    transition: all 0.3s ease;
}
.hover-shadow:hover {
    transform: translateY(-5px);
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
}
</style>

<script>
// Simple save function with clear visual feedback
async function saveNote(violationId) {
    const textarea = document.getElementById(`notes-${violationId}`);
    const saveBtn = document.getElementById(`save-btn-${violationId}`);
    const status = document.getElementById(`status-${violationId}`);
    const notes = textarea.value.trim();
    
    // Disable button and show loading
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
    
    console.log(`üíæ Saving note for violation ${violationId}:`, notes);
    
    try {
        const response = await fetch(`/violations/${violationId}/notes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ notes: notes })
        });
        
        if (response.ok) {
            const result = await response.json();
            console.log('‚úÖ Save successful:', result);
            
            // Show success
            saveBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Saved!';
            saveBtn.classList.remove('btn-primary');
            saveBtn.classList.add('btn-success');
            
            status.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> Saved successfully</span>';
            status.style.opacity = '1';
            
            // Reset button after 2 seconds
            setTimeout(() => {
                saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Note';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-primary');
                saveBtn.disabled = false;
                status.style.opacity = '0';
            }, 2000);
            
        } else {
            throw new Error(`Server error: ${response.status}`);
        }
        
    } catch (error) {
        console.error('‚ùå Save failed:', error);
        
        // Show error
        saveBtn.innerHTML = '<i class="bi bi-x-circle-fill"></i> Failed';
        saveBtn.classList.remove('btn-primary');
        saveBtn.classList.add('btn-danger');
        
        status.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle-fill"></i> Save failed - try again</span>';
        status.style.opacity = '1';
        
        // Reset button after 3 seconds
        setTimeout(() => {
            saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Note';
            saveBtn.classList.remove('btn-danger');
            saveBtn.classList.add('btn-primary');
            saveBtn.disabled = false;
            status.style.opacity = '0';
        }, 3000);
    }
}

console.log('üìù Violations page loaded - save buttons ready!');
</script>
{% endblock %}